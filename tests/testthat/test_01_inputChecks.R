
context("Check input via check_input")
library(eatDB)


# load test data (df1, df2, pkList, fkList)
load(file = "helper_dbdata.rda")
# load(file = "c:/Benjamin_Becker/02_Repositories/packages/eatDB/tests/testthat/helper_dbdata.rda")



### Checking primary and foreign keys
test_that("No errors if called correctly ", {
  expect_silent(check_input(dfList = dfList, pkList = pkList, fkList = fkList))
})


## expected errors
pkList2 <- list(df1 = "v1",
                df3 = "ID2")
pkList3 <- list(df1 = "v1",
                df2 = "ID2")
fkList2 <- list(df1 = list(References = "lala", Keys = NULL),
                df2 = list(References = "df1", Keys = "ID2"))
fkList3 <- list(df1 = list(References = NULL, Keys = NULL),
                df2 = list(References = NULL, Keys = "ID2"))
fkList4 <- list(df1 = list(References = NULL, Keys = NULL),
                df2 = list(References = "df1", Keys = "v1"))
fkList5 <- list(df1 = list(References = NULL, Keys = NULL),
                df2 = list(References = "df1", Keys = "v2"))


test_that("Errors are called correctly ", {
  expect_error(check_input(dfList = dfList, pkList = pkList2, fkList = fkList),
               "dfList and pkList have to have identical structure and namings.")
  expect_error(check_input(dfList = dfList, pkList = pkList, fkList = fkList2),
               "Foreign key defined for first data frame.")
  expect_error(check_input(dfList = dfList, pkList = pkList, fkList = fkList3),
               "Foreign Key reference for df2 must be exactly one other data frame.")
  expect_error(check_input(dfList = dfList, pkList = pkList, fkList = fkList4),
               "v1 are not variables in df2 .")
  expect_error(check_input(dfList = dfList, pkList = pkList, fkList = fkList5),
               "v2 are not variables in df1 .")
})

test_that("Errors are called correctly ", {
  names(dfList$df1) <- c("v.1", "ID2")
  expect_error(check_input(dfList = dfList, pkList = pkList, fkList = fkList),
               "Variable names are not allowed to contain '.' in SQLite.")
})

test_that("Error for character foreign keys", {
  dfList3 <- dfList2 <- dfList
  dfList2$df1$ID2 <- as.character(dfList$df1$ID2)
  dfList3$df2$ID2 <- as.factor(dfList$df2$ID2)
  expect_error(check_input(dfList = dfList2, pkList = pkList, fkList = fkList),
               "All foreign keys have to be numeric. Check keys in  df1 .")
  expect_error(check_input(dfList = dfList3, pkList = pkList, fkList = fkList),
               "All foreign keys have to be numeric. Check keys in  df2 .")
})

# tbd: further tests?


# should this test pass?
#   expect_error(addKeys(bigList = bigList, pkList = pkList3, fkList = fkList), "Foreign Key reference for df2 must be exactly one other data frame")
